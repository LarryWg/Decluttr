<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Assistant</title>
    <link rel="stylesheet" href="../../utils/theme.css">
    <link rel="stylesheet" href="email.css">
</head>
<body>
    <div class="container">
        <!-- Header with Back button and Settings -->
        <div class="header">
            <button class="backButton" id="backBtn">← Back</button>
            <h2>Email Assistant</h2>
            <button class="settingsButton" id="settingsBtn" title="Settings">⚙️</button>
        </div>

        <!-- Settings Panel (hidden by default) -->
        <div class="settingsPanel" id="settingsPanel" style="display: none;">
            <h3>Settings</h3>

            <section class="settingsSection">
                <h4 class="settingsSectionTitle">Account</h4>
                <div class="settingItem">
                    <button class="logoutButton" id="logoutBtn">Log out from Gmail</button>
                </div>
            </section>

            <section class="settingsSection">
                <h4 class="settingsSectionTitle">Appearance</h4>
                <div class="settingItem">
                    <label for="themeSelect">Theme</label>
                    <select id="themeSelect" class="settingSelect">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="system">System</option>
                    </select>
                </div>
            </section>

            <section class="settingsSection">
                <h4 class="settingsSectionTitle">Behavior</h4>
                <div class="settingItem settingItemRow">
                    <label for="autoCategorizeCheckbox" class="settingLabelInline">Auto-categorize emails on load</label>
                    <input type="checkbox" id="autoCategorizeCheckbox" class="settingCheckbox" checked>
                </div>
            </section>

            <section class="settingsSection" id="customLabelsSection">
                <h4 class="settingsSectionTitle">Custom auto-labels</h4>
                <p class="settingsSectionHint">Use the + beside Pipeline to add labels. Toggle &ldquo;Add to Gmail&rdquo; and run &ldquo;Apply labels to inbox&rdquo; to update Gmail.</p>
                <div class="customLabelsList" id="customLabelsList">
                    <!-- Custom labels rendered here -->
                </div>
                <div class="customLabelsActions">
                    <button type="button" class="button small" id="applyCustomLabelsBtn">Apply labels to inbox</button>
                </div>
            </section>

            <section class="settingsSection settingsSectionDeveloper">
                <button type="button" class="settingsDeveloperToggle" id="developerOptionsToggle" aria-expanded="false">
                    <span>Developer options</span>
                    <span class="settingsDeveloperChevron" aria-hidden="true">▼</span>
                </button>
                <div class="settingsDeveloperContent" id="developerOptionsContent" hidden>
                    <p class="settingsDeveloperHint">Copy the redirect URI below and add it to your OAuth client in Google Cloud Console (Credentials → your OAuth 2.0 Client ID → Authorized redirect URIs). If you have multiple clients for different testers, add this same URI to each one. After that, testers can connect Gmail without setup.</p>
                    <div class="settingItem">
                        <label for="backendUrlInput">Backend URL</label>
                        <input type="text" id="backendUrlInput" value="http://localhost:3000" placeholder="http://localhost:3000" class="settingInput" />
                        <button class="saveButton" id="saveBackendUrlBtn">Save</button>
                    </div>
                    <div class="settingItem">
                        <label for="redirectUriDisplay">Redirect URI</label>
                        <div class="settingInputRow">
                            <input type="text" id="redirectUriDisplay" readonly class="settingInput settingInputReadonly" />
                            <button type="button" class="button small" id="copyRedirectUriBtn">Copy</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Auth Section (shown when not authenticated) -->
        <div class="authSection" id="authSection">
            <p>Connect your Gmail account to get started</p>
            <button class="button primary" id="connectGmailBtn">Connect Gmail</button>
            <p class="infoText">You'll be asked to sign in and allow access to read and manage your mail.</p>
        </div>

        <!-- Loading Spinner -->
        <div class="loadingSpinner" id="loadingSpinner" style="display: none;">
            <div class="spinner"></div>
            <p>Loading emails...</p>
        </div>

        <!-- Error Message -->
        <div class="errorMessage" id="errorMessage" style="display: none;"></div>

        <!-- Success Message -->
        <div class="successMessage" id="successMessage" style="display: none;"></div>

        <!-- Email List Section -->
        <div class="emailListSection" id="emailListSection" style="display: none;">
            <div class="emailListHeader">
                <span id="accountEmail" class="accountEmail"></span>
                <button class="button small" id="refreshBtn">Refresh</button>
            </div>
            <div class="inboxTabs" id="inboxTabs">
                <button class="inboxTab active" data-inbox="primary">Primary</button>
                <button class="inboxTab" data-inbox="promotions">Promotions</button>
                <button class="inboxTab" data-inbox="job">Job</button>
                <button class="inboxTab" data-inbox="pipeline">Pipeline</button>
                <button type="button" class="inboxTabAdd" id="addCustomLabelTabBtn" title="Add custom label">+</button>
            </div>
            <button class="button small" id="managePromotionsBtn" style="display: none; width: 100%; margin-bottom: 12px;">Manage Promotions</button>
            <div class="emailList" id="emailList">
                <!-- Email cards will be inserted here -->
            </div>
            <button class="button small" id="loadMoreBtn" style="display: none; width: 100%; margin-top: 12px;">Load More</button>
            <div class="sankeySection" id="sankeySection" style="display: none;">
                <p class="sankeySectionDesc">Job application pipeline – edit below and copy or open in SankeyMATIC.</p>
                <div class="sankeyViewToggle" role="tablist" aria-label="Pipeline view">
                    <button type="button" class="sankeyViewToggleBtn active" id="sankeyCodeViewBtn" role="tab" aria-selected="true" data-view="code">Code</button>
                    <button type="button" class="sankeyViewToggleBtn" id="sankeyDiagramViewBtn" role="tab" aria-selected="false" data-view="diagram">Diagram</button>
                </div>
                <div id="sankeyCodeView" class="sankeyCodeView">
                    <textarea id="sankeyTextarea" class="sankeyTextarea" rows="12" placeholder="Company [count] Stage"></textarea>
                    <div class="sankeyActions">
                        <button type="button" class="button small" id="sankeyCopyBtn">Copy to clipboard</button>
                        <a href="https://sankeymatic.com/" target="_blank" rel="noopener noreferrer" class="button small" id="sankeyOpenBtn">Open in SankeyMATIC</a>
                        <button type="button" class="button small" id="sankeyExportBtn">Export as .txt</button>
                        <button type="button" class="button small" id="sankeyRefreshBtn">Refresh</button>
                    </div>
                </div>
                <div id="sankeyDiagramContainer" class="sankeyDiagramContainer" role="tabpanel" aria-hidden="true"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="emptyState" id="emptyState" style="display: none;">
            <p>No emails found</p>
        </div>
    </div>

    <!-- Unsubscribe Modal -->
    <div class="unsubscribeModal" id="unsubscribeModal" style="display: none;">
        <div class="modalContent unsubscribeModalContent">
            <p class="unsubscribeModalHint">Use Gmail&rsquo;s Unsubscribe button for reliable one-click unsubscribe.</p>
            <div class="unsubscribeModalDeleteOption">
                <label class="unsubscribeModalDeleteLabel">
                    <input type="checkbox" id="deleteEmailsCheckbox" class="unsubscribeModalDeleteCheckbox">
                    <span>Also move all emails from selected senders to trash</span>
                </label>
                <p class="unsubscribeModalDeleteHint">Emails can be recovered within 30 days.</p>
            </div>
            <div class="senderList" id="senderList">
                <!-- Sender list will be inserted here -->
            </div>
            <div class="modalActions">
                <button class="button" id="openInGmailBtn">Open in Gmail</button>
                <button class="button" id="cancelUnsubscribeBtn">Cancel</button>
                <button class="button primary" id="confirmUnsubscribeBtn">Unsubscribe &amp; optionally trash</button>
            </div>
        </div>
    </div>

    <!-- Email Detail Modal (for expanded email view) -->
    <div class="emailModal" id="emailModal" style="display: none;">
        <div class="modalContent">
            <button class="closeButton" id="closeModalBtn">×</button>
            <div class="modalHeader">
                <h3 id="modalSubject"></h3>
                <div class="modalMeta">
                    <span id="modalSender"></span>
                    <span id="modalDate"></span>
                </div>
            </div>
            <div class="modalBody">
                <div class="emailContent" id="modalBodyContent"></div>
                <div class="aiResults" id="modalAiResults">
                    <!-- AI results will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Custom Label Modal (opened by + beside Pipeline) -->
    <div class="emailModal" id="addCustomLabelModal" style="display: none;">
        <div class="modalContent addCustomLabelModalContent">
            <button class="closeButton" id="closeAddCustomLabelModalBtn" type="button" aria-label="Close">×</button>
            <h3 class="addCustomLabelModalTitle">Add custom label</h3>
            <p class="addCustomLabelModalHint">Create a label and describe what kind of emails should get it. AI will match emails when you run &ldquo;Apply labels to inbox&rdquo;.</p>
            <div class="settingItem">
                <label for="addCustomLabelModalName">Label name</label>
                <input type="text" id="addCustomLabelModalName" class="settingInput" placeholder="e.g. Work" maxlength="50" />
            </div>
            <div class="settingItem">
                <label for="addCustomLabelModalDescription">What kind of emails? (context for AI)</label>
                <textarea id="addCustomLabelModalDescription" class="settingTextarea" rows="3" placeholder="e.g. Emails from my team, internal updates, or work-related from my company domain"></textarea>
            </div>
            <div class="addCustomLabelModalActions">
                <button type="button" class="button" id="cancelAddCustomLabelModalBtn">Cancel</button>
                <button type="button" class="button primary" id="confirmAddCustomLabelModalBtn">Add label</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="lib/d3.min.js"></script>
    <script src="lib/d3-sankey.min.js"></script>
    <script src="gmail-auth.js"></script>
    <script type="module" src="email.js"></script>
</body>
</html>
