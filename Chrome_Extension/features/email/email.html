<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Assistant</title>
    <link rel="stylesheet" href="../../utils/theme.css">
    <link rel="stylesheet" href="email.css">
</head>
<body>
    <div class="container">
        <!-- Header with Back button and Settings -->
        <div class="header">
            <button class="backButton" id="backBtn">‚Üê Back</button>
            <h2>Email Assistant</h2>
            <button class="settingsButton" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
        </div>

        <!-- Settings Panel (hidden by default) -->
        <div class="settingsPanel" id="settingsPanel" style="display: none;">
            <div class="settingsPanelHeader">
                <h3>Settings</h3>
                <button type="button" class="settingsCloseBtn" id="settingsCloseBtn" aria-label="Close settings">√ó</button>
            </div>

            <!-- General Settings -->
            <section class="settingsSection">
                <h4 class="settingsSectionTitle">Appearance</h4>
                <div class="settingsCard">
                    <div class="settingRow">
                        <div class="settingRowLabel">
                            <span class="settingRowTitle">Theme</span>
                            <span class="settingRowDesc">Choose light, dark, or match your system</span>
                        </div>
                        <select id="themeSelect" class="settingSelect">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                </div>
            </section>

            <section class="settingsSection">
                <h4 class="settingsSectionTitle">Automation</h4>
                <div class="settingsCard">
                    <div class="settingRow">
                        <div class="settingRowLabel">
                            <span class="settingRowTitle">Auto-categorize</span>
                            <span class="settingRowDesc">Automatically sort emails when loaded</span>
                        </div>
                        <label class="settingToggle">
                            <input type="checkbox" id="autoCategorizeCheckbox" checked>
                            <span class="settingToggleSlider"></span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Custom Labels -->
            <section class="settingsSection" id="customLabelsSection">
                <h4 class="settingsSectionTitle">Custom Labels</h4>
                <div class="settingsCard">
                    <p class="settingsCardHint">Create labels using the + button in the tab bar. Enable "Sync to Gmail" to add labels in your Gmail account.</p>
                    <div class="customLabelsList" id="customLabelsList">
                        <!-- Custom labels rendered here -->
                    </div>
                    <button type="button" class="settingsActionBtn" id="applyCustomLabelsBtn">
                        Apply labels to inbox
                    </button>
                </div>
            </section>

            <!-- Account -->
            <section class="settingsSection">
                <h4 class="settingsSectionTitle">Account</h4>
                <div class="settingsCard">
                    <button type="button" class="settingsActionBtn settingsActionBtnDanger" id="logoutBtn">
                        Sign out of Gmail
                    </button>
                </div>
            </section>

            <!-- Developer Options -->
            <section class="settingsSection settingsSectionCollapsible">
                <button type="button" class="settingsSectionToggle" id="developerOptionsToggle" aria-expanded="false">
                    <h4 class="settingsSectionTitle">Developer</h4>
                    <span class="settingsSectionChevron">‚Ä∫</span>
                </button>
                <div class="settingsSectionContent" id="developerOptionsContent" hidden>
                    <div class="settingsCard">
                        <p class="settingsCardHint">Configure backend connection for development and testing.</p>
                        <div class="settingField">
                            <label for="backendUrlInput" class="settingFieldLabel">Backend URL</label>
                            <div class="settingFieldRow">
                                <input type="text" id="backendUrlInput" value="http://localhost:3000" placeholder="http://localhost:3000" class="settingInput" />
                                <button type="button" class="button small" id="saveBackendUrlBtn">Save</button>
                            </div>
                        </div>
                        <div class="settingField">
                            <label for="redirectUriDisplay" class="settingFieldLabel">OAuth Redirect URI</label>
                            <p class="settingFieldHint">Add this URI to your Google Cloud Console OAuth credentials.</p>
                            <div class="settingFieldRow">
                                <input type="text" id="redirectUriDisplay" readonly class="settingInput settingInputReadonly" />
                                <button type="button" class="button small" id="copyRedirectUriBtn">Copy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Auth Section (shown when not authenticated) -->
        <div class="authSection" id="authSection">
            <p>Connect your Gmail account to get started</p>
            <button class="button primary" id="connectGmailBtn">Connect Gmail</button>
            <p class="infoText">You'll be asked to sign in and allow access to read and manage your mail.</p>
        </div>

        <!-- Loading Spinner -->
        <div class="loadingSpinner" id="loadingSpinner" style="display: none;">
            <div class="spinner"></div>
            <p>Loading emails...</p>
        </div>

        <!-- Error Message -->
        <div class="errorMessage" id="errorMessage" style="display: none;"></div>

        <!-- Success Message -->
        <div class="successMessage" id="successMessage" style="display: none;"></div>

        <!-- Email List Section -->
        <div class="emailListSection" id="emailListSection" style="display: none;">
            <div class="emailListHeader">
                <span id="accountEmail" class="accountEmail"></span>
                <button class="button small" id="refreshBtn">Refresh</button>
            </div>

            <!-- Categorization Progress Bar -->
            <div class="categorizationProgress" id="categorizationProgress" style="display: none;">
                <div class="categorizationProgressHeader">
                    <span class="categorizationProgressLabel">AI Categorizing</span>
                    <span class="categorizationProgressCount" id="categorizationProgressCount">0/0</span>
                </div>
                <div class="categorizationProgressBar">
                    <div class="categorizationProgressFill" id="categorizationProgressFill"></div>
                </div>
            </div>

            <!-- Stats Dashboard -->
            <div class="statsDashboard" id="statsDashboard">
                <div class="statsGrid">
                    <div class="statCard statCardTotal">
                        <div class="statIcon">üìß</div>
                        <div class="statContent">
                            <div class="statValue" id="statTotalEmails">0</div>
                            <div class="statLabel">Emails Processed</div>
                        </div>
                    </div>
                    <div class="statCard statCardJobs">
                        <div class="statIcon">üíº</div>
                        <div class="statContent">
                            <div class="statValue" id="statJobApps">0</div>
                            <div class="statLabel">Job Applications</div>
                        </div>
                        <div class="statMiniChart" id="statJobMiniChart"></div>
                    </div>
                    <div class="statCard statCardResponse">
                        <div class="statIcon">üìà</div>
                        <div class="statContent">
                            <div class="statValue" id="statResponseRate">0%</div>
                            <div class="statLabel">Response Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="inboxTabs" id="inboxTabs">
                <button class="inboxTab active" data-inbox="primary">Primary</button>
                <button class="inboxTab" data-inbox="promotions">Promotions</button>
                <button class="inboxTab" data-inbox="job">Job</button>
                <button class="inboxTab" data-inbox="pipeline">Pipeline</button>
                <button type="button" class="inboxTabAdd" id="addCustomLabelTabBtn" title="Add custom label">+</button>
            </div>
            <button class="button small" id="managePromotionsBtn" style="display: none; width: 100%; margin-bottom: 12px;">Manage Promotions</button>
            <div class="emailList" id="emailList">
                <!-- Email cards will be inserted here -->
            </div>
            <button class="button small" id="loadMoreBtn" style="display: none; width: 100%; margin-top: 12px;">Load More</button>
            <div class="sankeySection" id="sankeySection" style="display: none;">
                <p class="sankeySectionDesc">Job application pipeline ‚Äì edit below and copy or open in SankeyMATIC.</p>
                <div class="sankeyViewToggle" role="tablist" aria-label="Pipeline view">
                    <button type="button" class="sankeyViewToggleBtn active" id="sankeyCodeViewBtn" role="tab" aria-selected="true" data-view="code">Code</button>
                    <button type="button" class="sankeyViewToggleBtn" id="sankeyDiagramViewBtn" role="tab" aria-selected="false" data-view="diagram">Diagram</button>
                </div>
                <div id="sankeyCodeView" class="sankeyCodeView">
                    <textarea id="sankeyTextarea" class="sankeyTextarea" rows="12" placeholder="Company [count] Stage"></textarea>
                    <div class="sankeyActions">
                        <button type="button" class="button small" id="sankeyCopyBtn">Copy to clipboard</button>
                        <a href="https://sankeymatic.com/" target="_blank" rel="noopener noreferrer" class="button small" id="sankeyOpenBtn">Open in SankeyMATIC</a>
                        <button type="button" class="button small" id="sankeyExportBtn">Export as .txt</button>
                        <button type="button" class="button small" id="sankeyRefreshBtn">Refresh</button>
                    </div>
                </div>
                <div id="sankeyDiagramContainer" class="sankeyDiagramContainer" role="tabpanel" aria-hidden="true"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="emptyState" id="emptyState" style="display: none;">
            <p>No emails found</p>
        </div>
    </div>

    <!-- Unsubscribe Modal -->
    <div class="unsubscribeModal" id="unsubscribeModal" style="display: none;">
        <div class="modalContent unsubscribeModalContent">
            <p class="unsubscribeModalHint">Use Gmail&rsquo;s Unsubscribe button for reliable one-click unsubscribe.</p>
            <div class="unsubscribeModalDeleteOption">
                <label class="unsubscribeModalDeleteLabel">
                    <input type="checkbox" id="deleteEmailsCheckbox" class="unsubscribeModalDeleteCheckbox">
                    <span>Also move all emails from selected senders to trash</span>
                </label>
                <p class="unsubscribeModalDeleteHint">Emails can be recovered within 30 days.</p>
            </div>
            <div class="senderList" id="senderList">
                <!-- Sender list will be inserted here -->
            </div>
            <div class="modalActions">
                <button class="button" id="openInGmailBtn">Open in Gmail</button>
                <button class="button" id="cancelUnsubscribeBtn">Cancel</button>
                <button class="button primary" id="confirmUnsubscribeBtn">Unsubscribe &amp; optionally trash</button>
            </div>
        </div>
    </div>

    <!-- Email Detail Modal (for expanded email view) -->
    <div class="emailModal" id="emailModal" style="display: none;">
        <div class="modalContent">
            <button class="closeButton" id="closeModalBtn">√ó</button>
            <div class="modalHeader">
                <h3 id="modalSubject"></h3>
                <div class="modalMeta">
                    <span id="modalSender"></span>
                    <span id="modalDate"></span>
                </div>
            </div>
            <div class="modalBody">
                <div class="emailContent" id="modalBodyContent"></div>
                <div class="aiResults" id="modalAiResults">
                    <!-- AI results will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Custom Label Modal (opened by + beside Pipeline) -->
    <div class="emailModal" id="addCustomLabelModal" style="display: none;">
        <div class="modalContent addCustomLabelModalContent">
            <button class="closeButton" id="closeAddCustomLabelModalBtn" type="button" aria-label="Close">√ó</button>
            <h3 class="addCustomLabelModalTitle">Add custom label</h3>
            <p class="addCustomLabelModalHint">Create a label and describe what kind of emails should get it. AI will match emails when you run &ldquo;Apply labels to inbox&rdquo;.</p>
            <div class="settingItem">
                <label for="addCustomLabelModalName">Label name</label>
                <input type="text" id="addCustomLabelModalName" class="settingInput" placeholder="e.g. Work" maxlength="50" />
            </div>
            <div class="settingItem">
                <label for="addCustomLabelModalDescription">What kind of emails? (context for AI)</label>
                <textarea id="addCustomLabelModalDescription" class="settingTextarea" rows="3" placeholder="e.g. Emails from my team, internal updates, or work-related from my company domain"></textarea>
            </div>
            <div class="addCustomLabelModalActions">
                <button type="button" class="button" id="cancelAddCustomLabelModalBtn">Cancel</button>
                <button type="button" class="button primary" id="confirmAddCustomLabelModalBtn">Add label</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="lib/d3.min.js"></script>
    <script src="lib/d3-sankey.min.js"></script>
    <script src="gmail-auth.js"></script>
    <script type="module" src="email.js"></script>
</body>
</html>
